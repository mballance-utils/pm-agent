name: Weekly Project Summary

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'
  workflow_call:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'
    secrets:
      COPILOT_TOKEN:
        description: 'GitHub token with Copilot access'
        required: true

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup workspace
        run: |
          mkdir -p projects
          mkdir -p prompts
      
      - name: Checkout prompt repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.prompt_repo }}
          ref: ${{ inputs.prompt_ref }}
          path: prompts-repo
      
      - name: Copy prompts
        run: |
          cp -r prompts-repo/prompts/* prompts/
          ls -la prompts/
      
      - name: Clone project repositories
        run: |
          cd projects
          IFS=',' read -ra URLS <<< "${{ inputs.project_urls }}"
          for url in "${URLS[@]}"; do
            url=$(echo "$url" | xargs)  # trim whitespace
            echo "Cloning $url"
            git clone "$url"
          done
          ls -la
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
      
      - name: Install GitHub Copilot CLI
        run: |
          npm install -g @github/copilot
          
          # Verify installation
          copilot --version
      
      - name: Authenticate Copilot CLI
        run: |
          # Authenticate gh CLI for repo cloning
          echo "${{ secrets.GITHUB_TOKEN }}" | gh auth login --with-token
          gh auth status
      
      - name: Run Copilot CLI Weekly Summary
        run: |
          cd projects
          
          # Create the prompt with absolute path to weekly.md
          PROMPT_FILE="${GITHUB_WORKSPACE}/prompts/weekly.md"
          
          echo "Running weekly summary for ${{ inputs.project_name }}"
          echo "Prompt file: $PROMPT_FILE"
          
          # Read the prompt content
          if [ -f "$PROMPT_FILE" ]; then
            PROMPT_CONTENT=$(cat "$PROMPT_FILE")
            # Run standalone copilot CLI with the prompt in non-interactive mode
            copilot -p "Create a weekly summary for ${{ inputs.project_name }} based on these instructions: $PROMPT_CONTENT"
          else
            echo "Prompt file not found: $PROMPT_FILE"
            exit 1
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.COPILOT_TOKEN }}
      
      - name: Organize weekly report
        run: |
          # Get current year and week number
          YEAR=$(date +%Y)
          WEEK=$(date +%U)
          
          # Find the weekly_report.md file
          REPORT=$(find projects -name "weekly_report.md" -type f | head -n 1)
          
          if [ -n "$REPORT" ]; then
            # Create updates directory structure
            mkdir -p updates/${YEAR}
            
            # Copy report to structured location
            cp "$REPORT" updates/${YEAR}/${WEEK}.md
            echo "Report organized: updates/${YEAR}/${WEEK}.md"
          else
            echo "No weekly_report.md found"
            exit 1
          fi
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add weekly update for ${{ inputs.project_name }} - Week ${{ github.run_number }}"
          branch: weekly-update-${{ github.run_number }}
          title: "Weekly Update: ${{ inputs.project_name }} - $(date +%Y) Week $(date +%U)"
          body: |
            Automated weekly summary for **${{ inputs.project_name }}**
            
            - **Year:** $(date +%Y)
            - **Week:** $(date +%U)
            - **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            This report was automatically generated based on project activity.
          add-paths: |
            updates/**/*.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-summary-${{ inputs.project_name }}
          path: |
            updates/**/*.md
            projects/**/weekly_report.md
            projects/**/summary*.md
          if-no-files-found: warn
