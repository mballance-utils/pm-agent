name: Weekly Project Summary

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'
  workflow_call:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      models: read
    
    steps:
      - name: Setup workspace
        run: |
          mkdir -p projects
          mkdir -p prompts
      
      - name: Checkout prompt repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.prompt_repo }}
          ref: ${{ inputs.prompt_ref }}
          path: prompts-repo
      
      - name: Copy prompts
        run: |
          cp -r prompts-repo/prompts/* prompts/
          ls -la prompts/
      
      - name: Clone project repositories
        run: |
          cd projects
          IFS=',' read -ra URLS <<< "${{ inputs.project_urls }}"
          for url in "${URLS[@]}"; do
            url=$(echo "$url" | xargs)  # trim whitespace
            echo "Cloning $url"
            git clone "$url"
          done
          ls -la
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Gather project context
        id: context
        run: |
          cd projects
          
          # Collect recent commit information
          CONTEXT=""
          for dir in */; do
            if [ -d "$dir/.git" ]; then
              echo "Processing $dir"
              cd "$dir"
              REPO_NAME=$(basename "$dir")
              COMMITS=$(git log --since="7 days ago" --pretty=format:"- %h %s (%an, %ar)" --no-merges | head -20)
              if [ -n "$COMMITS" ]; then
                CONTEXT="$CONTEXT\n\n## Repository: $REPO_NAME\n\nRecent commits:\n$COMMITS"
              fi
              cd ..
            fi
          done
          
          # Save context to file
          echo -e "$CONTEXT" > ${GITHUB_WORKSPACE}/project_context.txt
          echo "Context gathered for ${{ inputs.project_name }}"
          
      - name: Run AI Weekly Summary
        id: ai_summary
        uses: actions/ai-inference@v1
        with:
          model: 'anthropic/claude-sonnet-4.5'
          prompt-file: 'prompts/weekly.md'
          input: |
            project_name: ${{ inputs.project_name }}
            project_context: ${{ github.workspace }}/project_context.txt
      
      - name: Save AI summary to file
        run: |
          # Get current year and week number
          YEAR=$(date +%Y)
          WEEK=$(date +%U)
          
          # Create updates directory structure
          mkdir -p updates/${YEAR}
          
          # Save the AI response to the weekly report
          echo "${{ steps.ai_summary.outputs.response }}" > updates/${YEAR}/${WEEK}.md
          echo "Report created: updates/${YEAR}/${WEEK}.md"
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Add weekly update for ${{ inputs.project_name }} - Week ${{ github.run_number }}"
          branch: weekly-update-${{ github.run_number }}
          title: "Weekly Update: ${{ inputs.project_name }} - $(date +%Y) Week $(date +%U)"
          body: |
            Automated weekly summary for **${{ inputs.project_name }}**
            
            - **Year:** $(date +%Y)
            - **Week:** $(date +%U)
            - **Generated:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            This report was automatically generated based on project activity using GitHub Models API.
          add-paths: |
            updates/**/*.md
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-summary-${{ inputs.project_name }}
          path: updates/**/*.md
          if-no-files-found: warn
