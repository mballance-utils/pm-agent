name: Weekly Project Summary

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'
  workflow_call:
    inputs:
      project_name:
        description: 'Project name'
        required: true
        type: string
      project_urls:
        description: 'Project repository URLs (comma-separated)'
        required: true
        type: string
      prompt_repo:
        description: 'Repository containing prompts (format: owner/repo)'
        required: false
        type: string
        default: 'mballance-utils/pm-agent'
      prompt_ref:
        description: 'Branch/tag/commit of prompt repository'
        required: false
        type: string
        default: 'main'

jobs:
  generate-summary:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
      issues: read
      models: read
    
    steps:
      - name: Checkout current repository
        uses: actions/checkout@v4
      
      - name: Setup workspace
        run: |
          mkdir -p projects
          mkdir -p prompts
      
      - name: Checkout prompt repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.prompt_repo }}
          ref: ${{ inputs.prompt_ref }}
          path: prompts-repo
      
      - name: Copy prompts
        run: |
          cp -r prompts-repo/prompts/* prompts/
          ls -la prompts/
      
      - name: Clone project repositories
        run: |
          cd projects
          IFS=',' read -ra URLS <<< "${{ inputs.project_urls }}"
          for url in "${URLS[@]}"; do
            url=$(echo "$url" | xargs)  # trim whitespace
            echo "Cloning $url"
            git clone "$url"
          done
          ls -la
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Gather project context
        id: context
        run: |
          cd projects
          
          # Get date 7 days ago
          SINCE_DATE=$(date -d '7 days ago' +%Y-%m-%d)
          
          # Collect comprehensive project information
          CONTEXT_FILE="${GITHUB_WORKSPACE}/project_context.txt"
          > "$CONTEXT_FILE"  # Clear file
          
          echo "# Project: ${{ inputs.project_name }}" >> "$CONTEXT_FILE"
          echo "Report Date: $(date +%Y-%m-%d)" >> "$CONTEXT_FILE"
          echo "Period: Last 7 days (since $SINCE_DATE)" >> "$CONTEXT_FILE"
          echo "" >> "$CONTEXT_FILE"
          
          for dir in */; do
            if [ -d "$dir/.git" ]; then
              echo "Processing $dir"
              cd "$dir"
              REPO_NAME=$(basename "$dir")
              REPO_URL=$(git config --get remote.origin.url)
              
              echo "## Repository: $REPO_NAME" >> "$CONTEXT_FILE"
              echo "URL: $REPO_URL" >> "$CONTEXT_FILE"
              echo "" >> "$CONTEXT_FILE"
              
              # Recent commits
              echo "### Recent Commits" >> "$CONTEXT_FILE"
              COMMITS=$(git log --since="$SINCE_DATE" --pretty=format:"- %h %s (%an, %ar)" --no-merges | head -20)
              if [ -n "$COMMITS" ]; then
                echo "$COMMITS" >> "$CONTEXT_FILE"
              else
                echo "No commits in the last 7 days" >> "$CONTEXT_FILE"
              fi
              echo "" >> "$CONTEXT_FILE"
              
              # Get org and repo name for gh commands
              if [[ "$REPO_URL" =~ github\.com[:/]([^/]+)/([^/.]+) ]]; then
                ORG="${BASH_REMATCH[1]}"
                REPO="${BASH_REMATCH[2]}"
                
                echo "### Issues (Last 7 Days)" >> "$CONTEXT_FILE"
                
                # New issues
                echo "#### Opened Issues:" >> "$CONTEXT_FILE"
                gh issue list --repo "$ORG/$REPO" --state all --search "created:>=$SINCE_DATE" --limit 50 --json number,title,state,createdAt,author | \
                  jq -r '.[] | "- #\(.number): \(.title) [\(.state)] (by @\(.author.login), \(.createdAt | fromdate | strftime("%Y-%m-%d")))"' >> "$CONTEXT_FILE" || echo "Unable to fetch issues" >> "$CONTEXT_FILE"
                echo "" >> "$CONTEXT_FILE"
                
                # Closed issues
                echo "#### Closed Issues:" >> "$CONTEXT_FILE"
                gh issue list --repo "$ORG/$REPO" --state closed --search "closed:>=$SINCE_DATE" --limit 50 --json number,title,closedAt,author | \
                  jq -r '.[] | "- #\(.number): \(.title) (by @\(.author.login), closed \(.closedAt | fromdate | strftime("%Y-%m-%d")))"' >> "$CONTEXT_FILE" || echo "Unable to fetch closed issues" >> "$CONTEXT_FILE"
                echo "" >> "$CONTEXT_FILE"
                
                echo "### Pull Requests (Last 7 Days)" >> "$CONTEXT_FILE"
                
                # New PRs
                echo "#### Opened PRs:" >> "$CONTEXT_FILE"
                gh pr list --repo "$ORG/$REPO" --state all --search "created:>=$SINCE_DATE" --limit 50 --json number,title,state,createdAt,author | \
                  jq -r '.[] | "- #\(.number): \(.title) [\(.state)] (by @\(.author.login), \(.createdAt | fromdate | strftime("%Y-%m-%d")))"' >> "$CONTEXT_FILE" || echo "Unable to fetch PRs" >> "$CONTEXT_FILE"
                echo "" >> "$CONTEXT_FILE"
                
                # Merged PRs
                echo "#### Merged PRs:" >> "$CONTEXT_FILE"
                gh pr list --repo "$ORG/$REPO" --state merged --search "merged:>=$SINCE_DATE" --limit 50 --json number,title,mergedAt,author | \
                  jq -r '.[] | "- #\(.number): \(.title) (by @\(.author.login), merged \(.mergedAt | fromdate | strftime("%Y-%m-%d")))"' >> "$CONTEXT_FILE" || echo "Unable to fetch merged PRs" >> "$CONTEXT_FILE"
                echo "" >> "$CONTEXT_FILE"
              fi
              
              cd ..
            fi
          done
          
          echo "Context gathered for ${{ inputs.project_name }}"
          echo "Context file size: $(wc -l < $CONTEXT_FILE) lines"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Run AI Weekly Summary
        id: ai_summary
        uses: actions/ai-inference@v1
        with:
          model: 'gpt-4o'
          prompt-file: 'prompts/weekly.md'
          input: |
            project_name: ${{ inputs.project_name }}
            working_dir: ${{ github.workspace }}/projects
            
            Project data has been gathered and is available in the working directory.
            Each repository has been cloned with full context including:
            - Recent commits from the last 7 days
            - Issues opened and closed in the last 7 days  
            - Pull requests opened and merged in the last 7 days
            
            Full details are in: ${{ github.workspace }}/project_context.txt
            
            You have access to:
            - gh CLI tool for querying GitHub data
            - All cloned repositories in the projects/ directory
            - The project_context.txt file with pre-gathered data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Save AI summary to file
        run: |
          # Get current year and week number
          YEAR=$(date +%Y)
          WEEK=$(date +%U)
          
          # Create updates directory structure
          mkdir -p updates/${YEAR}
          
          # Save the AI response to the weekly report using cat with heredoc
          cat > updates/${YEAR}/${WEEK}.md << 'EOFREPORT'
          ${{ steps.ai_summary.outputs.response }}
          EOFREPORT
          
          echo "Report created: updates/${YEAR}/${WEEK}.md"
          
          # Also save to job summary for easy viewing
          cat updates/${YEAR}/${WEEK}.md >> $GITHUB_STEP_SUMMARY
      
      - name: Upload summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: weekly-summary-${{ inputs.project_name }}
          path: updates/**/*.md
          if-no-files-found: warn
